##############################################################################
# ASM - Asset Service Manager
# PaddiSense Farm Management System
#
# This package provides complete asset and parts management for:
#   - Tractors, Pumps, Harvesters, Vehicles
#   - Parts (Filters, Belts, Oils, etc.) with stock tracking
#   - Service events that consume parts
#
# Features:
#   - Asset management with custom attributes
#   - Parts linked to assets (or universal)
#   - Single-location stock tracking
#   - Service event recording with auto-deduct
#   - Low stock alerts
##############################################################################

#=============================================================================
# COMMAND LINE SENSOR - Main data source
#=============================================================================
command_line:
  - sensor:
      name: ASM Data
      unique_id: asm_data
      command: 'python3 /config/PaddiSense/asm/python/asm_sensor.py'
      command_timeout: 30
      scan_interval: 300
      value_template: '{{ value_json.total_parts | default(0) }}'
      json_attributes:
        - total_assets
        - total_parts
        - low_stock_count
        - assets
        - parts
        - asset_names
        - part_names
        - asset_id_to_name
        - part_id_to_name
        - recent_events
        - event_labels
        - event_id_to_label
        - asset_categories
        - part_categories
        - service_types

#=============================================================================
# SHELL COMMANDS - Python backend calls
#=============================================================================
shell_command:
  # Asset commands
  asm_add_asset: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py add_asset
    --name "{{ name }}"
    --category "{{ category }}"
    --attributes '{{ attributes }}'

  asm_edit_asset: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py edit_asset
    --id "{{ asset_id }}"
    --name "{{ name }}"
    --category "{{ category }}"
    --attributes '{{ attributes }}'

  asm_delete_asset: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py delete_asset
    --id "{{ asset_id }}"

  # Part commands
  asm_add_part: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py add_part
    --name "{{ name }}"
    --part_number "{{ part_number }}"
    --category "{{ category }}"
    --unit "{{ unit }}"
    --stock "{{ stock }}"
    --min_stock "{{ min_stock }}"
    --assets '{{ assets }}'
    --universal "{{ universal }}"
    --attributes '{{ attributes }}'

  asm_edit_part: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py edit_part
    --id "{{ part_id }}"
    --name "{{ name }}"
    --part_number "{{ part_number }}"
    --category "{{ category }}"
    --unit "{{ unit }}"
    --min_stock "{{ min_stock }}"
    --assets '{{ assets }}'
    --universal "{{ universal }}"
    --attributes '{{ attributes }}'

  asm_delete_part: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py delete_part
    --id "{{ part_id }}"

  asm_adjust_stock: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py adjust_stock
    --id "{{ part_id }}"
    --delta "{{ delta }}"

  # Service event command
  asm_record_service: >-
    python3 /config/PaddiSense/asm/python/asm_backend.py record_service
    --asset "{{ asset_id }}"
    --type "{{ service_type }}"
    --parts '{{ parts }}'
    --notes "{{ notes }}"
    --hours "{{ hours }}"

#=============================================================================
# INPUT HELPERS - User interface controls
#=============================================================================
input_select:
  # ----- Asset Management -----
  asm_asset:
    name: ASM Asset
    icon: mdi:tractor
    options:
      - Select Asset

  asm_asset_category:
    name: ASM Asset Category
    icon: mdi:shape
    options:
      - Tractor
      - Pump
      - Harvester
      - Vehicle

  asm_editor_mode:
    name: ASM Editor Mode
    icon: mdi:pencil
    options:
      - View
      - Add New
      - Edit Existing

  asm_part_editor_mode:
    name: ASM Part Editor Mode
    icon: mdi:pencil
    options:
      - View
      - Add New
      - Edit Existing

  # ----- Part Management -----
  asm_part:
    name: ASM Part
    icon: mdi:cog
    options:
      - Select Part

  asm_part_category:
    name: ASM Part Category
    icon: mdi:shape-outline
    options:
      - Filter
      - Belt
      - Oil
      - Grease
      - Battery
      - Tyre
      - Hose

  asm_part_unit:
    name: ASM Part Unit
    icon: mdi:scale
    options:
      - ea
      - L
      - kg
      - m

  # Part-to-Asset assignments (up to 5)
  asm_part_asset_1:
    name: ASM Part Asset 1
    icon: mdi:link
    options:
      - None

  asm_part_asset_2:
    name: ASM Part Asset 2
    icon: mdi:link
    options:
      - None

  asm_part_asset_3:
    name: ASM Part Asset 3
    icon: mdi:link
    options:
      - None

  asm_part_asset_4:
    name: ASM Part Asset 4
    icon: mdi:link
    options:
      - None

  asm_part_asset_5:
    name: ASM Part Asset 5
    icon: mdi:link
    options:
      - None

  # ----- Service Event -----
  asm_service_asset:
    name: ASM Service Asset
    icon: mdi:wrench
    options:
      - Select Asset

  asm_service_type:
    name: ASM Service Type
    icon: mdi:clipboard-check
    options:
      - 250 Hr Service
      - 500 Hr Service
      - 1000 Hr Service
      - Annual Service
      - Repair
      - Inspection
      - Other

  # Parts consumed (up to 5)
  asm_consume_part_1:
    name: ASM Consume Part 1
    icon: mdi:minus-circle
    options:
      - None

  asm_consume_part_2:
    name: ASM Consume Part 2
    icon: mdi:minus-circle
    options:
      - None

  asm_consume_part_3:
    name: ASM Consume Part 3
    icon: mdi:minus-circle
    options:
      - None

  asm_consume_part_4:
    name: ASM Consume Part 4
    icon: mdi:minus-circle
    options:
      - None

  asm_consume_part_5:
    name: ASM Consume Part 5
    icon: mdi:minus-circle
    options:
      - None

  # ----- Report View Filter -----
  asm_report_asset:
    name: ASM Report Asset Filter
    icon: mdi:filter
    options:
      - All Assets

  # ----- Service Event Viewer -----
  asm_service_event:
    name: ASM Service Event
    icon: mdi:clipboard-text-clock
    options:
      - Select Event

input_number:
  # Part stock
  asm_part_stock:
    name: ASM Part Stock
    icon: mdi:package-variant
    min: 0
    max: 99999
    step: 1
    mode: box

  asm_part_min_stock:
    name: ASM Part Min Stock
    icon: mdi:alert-outline
    min: 0
    max: 99999
    step: 1
    mode: box

  # Stock adjustment
  asm_stock_delta:
    name: ASM Stock Adjustment
    icon: mdi:plus-minus
    min: -99999
    max: 99999
    step: 1
    mode: box

  # Part consumption quantities
  asm_consume_qty_1:
    name: ASM Consume Qty 1
    icon: mdi:numeric
    min: 0
    max: 999
    step: 1
    mode: box

  asm_consume_qty_2:
    name: ASM Consume Qty 2
    icon: mdi:numeric
    min: 0
    max: 999
    step: 1
    mode: box

  asm_consume_qty_3:
    name: ASM Consume Qty 3
    icon: mdi:numeric
    min: 0
    max: 999
    step: 1
    mode: box

  asm_consume_qty_4:
    name: ASM Consume Qty 4
    icon: mdi:numeric
    min: 0
    max: 999
    step: 1
    mode: box

  asm_consume_qty_5:
    name: ASM Consume Qty 5
    icon: mdi:numeric
    min: 0
    max: 999
    step: 1
    mode: box

input_text:
  # Asset name
  asm_asset_name:
    name: ASM Asset Name
    icon: mdi:rename
    max: 80

  # Part name and number
  asm_part_name:
    name: ASM Part Name
    icon: mdi:rename
    max: 80

  asm_part_number:
    name: ASM Part Number
    icon: mdi:barcode
    max: 50

  # Asset attributes (5 slots: name/value pairs)
  asm_attr_1_name:
    name: ASM Attr 1 Name
    icon: mdi:tag
    max: 30

  asm_attr_1_value:
    name: ASM Attr 1 Value
    icon: mdi:text
    max: 50

  asm_attr_2_name:
    name: ASM Attr 2 Name
    icon: mdi:tag
    max: 30

  asm_attr_2_value:
    name: ASM Attr 2 Value
    icon: mdi:text
    max: 50

  asm_attr_3_name:
    name: ASM Attr 3 Name
    icon: mdi:tag
    max: 30

  asm_attr_3_value:
    name: ASM Attr 3 Value
    icon: mdi:text
    max: 50

  asm_attr_4_name:
    name: ASM Attr 4 Name
    icon: mdi:tag
    max: 30

  asm_attr_4_value:
    name: ASM Attr 4 Value
    icon: mdi:text
    max: 50

  asm_attr_5_name:
    name: ASM Attr 5 Name
    icon: mdi:tag
    max: 30

  asm_attr_5_value:
    name: ASM Attr 5 Value
    icon: mdi:text
    max: 50

  asm_attr_6_name:
    name: ASM Attr 6 Name
    icon: mdi:tag
    max: 30

  asm_attr_6_value:
    name: ASM Attr 6 Value
    icon: mdi:text
    max: 50

  asm_attr_7_name:
    name: ASM Attr 7 Name
    icon: mdi:tag
    max: 30

  asm_attr_7_value:
    name: ASM Attr 7 Value
    icon: mdi:text
    max: 50

  asm_attr_8_name:
    name: ASM Attr 8 Name
    icon: mdi:tag
    max: 30

  asm_attr_8_value:
    name: ASM Attr 8 Value
    icon: mdi:text
    max: 50

  asm_attr_9_name:
    name: ASM Attr 9 Name
    icon: mdi:tag
    max: 30

  asm_attr_9_value:
    name: ASM Attr 9 Value
    icon: mdi:text
    max: 50

  asm_attr_10_name:
    name: ASM Attr 10 Name
    icon: mdi:tag
    max: 30

  asm_attr_10_value:
    name: ASM Attr 10 Value
    icon: mdi:text
    max: 50

  asm_attr_11_name:
    name: ASM Attr 11 Name
    icon: mdi:tag
    max: 30

  asm_attr_11_value:
    name: ASM Attr 11 Value
    icon: mdi:text
    max: 50

  asm_attr_12_name:
    name: ASM Attr 12 Name
    icon: mdi:tag
    max: 30

  asm_attr_12_value:
    name: ASM Attr 12 Value
    icon: mdi:text
    max: 50

  asm_attr_13_name:
    name: ASM Attr 13 Name
    icon: mdi:tag
    max: 30

  asm_attr_13_value:
    name: ASM Attr 13 Value
    icon: mdi:text
    max: 50

  asm_attr_14_name:
    name: ASM Attr 14 Name
    icon: mdi:tag
    max: 30

  asm_attr_14_value:
    name: ASM Attr 14 Value
    icon: mdi:text
    max: 50

  asm_attr_15_name:
    name: ASM Attr 15 Name
    icon: mdi:tag
    max: 30

  asm_attr_15_value:
    name: ASM Attr 15 Value
    icon: mdi:text
    max: 50

  # Part attributes (15 slots)
  asm_part_attr_1_name:
    name: ASM Part Attr 1 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_1_value:
    name: ASM Part Attr 1 Value
    icon: mdi:text
    max: 50

  asm_part_attr_2_name:
    name: ASM Part Attr 2 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_2_value:
    name: ASM Part Attr 2 Value
    icon: mdi:text
    max: 50

  asm_part_attr_3_name:
    name: ASM Part Attr 3 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_3_value:
    name: ASM Part Attr 3 Value
    icon: mdi:text
    max: 50

  asm_part_attr_4_name:
    name: ASM Part Attr 4 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_4_value:
    name: ASM Part Attr 4 Value
    icon: mdi:text
    max: 50

  asm_part_attr_5_name:
    name: ASM Part Attr 5 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_5_value:
    name: ASM Part Attr 5 Value
    icon: mdi:text
    max: 50

  asm_part_attr_6_name:
    name: ASM Part Attr 6 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_6_value:
    name: ASM Part Attr 6 Value
    icon: mdi:text
    max: 50

  asm_part_attr_7_name:
    name: ASM Part Attr 7 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_7_value:
    name: ASM Part Attr 7 Value
    icon: mdi:text
    max: 50

  asm_part_attr_8_name:
    name: ASM Part Attr 8 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_8_value:
    name: ASM Part Attr 8 Value
    icon: mdi:text
    max: 50

  asm_part_attr_9_name:
    name: ASM Part Attr 9 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_9_value:
    name: ASM Part Attr 9 Value
    icon: mdi:text
    max: 50

  asm_part_attr_10_name:
    name: ASM Part Attr 10 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_10_value:
    name: ASM Part Attr 10 Value
    icon: mdi:text
    max: 50

  asm_part_attr_11_name:
    name: ASM Part Attr 11 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_11_value:
    name: ASM Part Attr 11 Value
    icon: mdi:text
    max: 50

  asm_part_attr_12_name:
    name: ASM Part Attr 12 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_12_value:
    name: ASM Part Attr 12 Value
    icon: mdi:text
    max: 50

  asm_part_attr_13_name:
    name: ASM Part Attr 13 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_13_value:
    name: ASM Part Attr 13 Value
    icon: mdi:text
    max: 50

  asm_part_attr_14_name:
    name: ASM Part Attr 14 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_14_value:
    name: ASM Part Attr 14 Value
    icon: mdi:text
    max: 50

  asm_part_attr_15_name:
    name: ASM Part Attr 15 Name
    icon: mdi:tag
    max: 30

  asm_part_attr_15_value:
    name: ASM Part Attr 15 Value
    icon: mdi:text
    max: 50

  # Service event notes and hours
  asm_service_notes:
    name: ASM Service Notes
    icon: mdi:note-text
    max: 200

  asm_service_hours:
    name: ASM Engine Hours
    icon: mdi:counter
    max: 20

input_boolean:
  # Universal part toggle
  asm_universal_part:
    name: ASM Universal Part
    icon: mdi:earth

  # Show additional attribute slots
  asm_show_attr_2:
    name: ASM Show Attr 2
    icon: mdi:plus-circle-outline

  asm_show_attr_3:
    name: ASM Show Attr 3
    icon: mdi:plus-circle-outline

  asm_show_attr_4:
    name: ASM Show Attr 4
    icon: mdi:plus-circle-outline

  asm_show_attr_5:
    name: ASM Show Attr 5
    icon: mdi:plus-circle-outline

  asm_show_attr_6:
    name: ASM Show Attr 6
    icon: mdi:plus-circle-outline

  asm_show_attr_7:
    name: ASM Show Attr 7
    icon: mdi:plus-circle-outline

  asm_show_attr_8:
    name: ASM Show Attr 8
    icon: mdi:plus-circle-outline

  asm_show_attr_9:
    name: ASM Show Attr 9
    icon: mdi:plus-circle-outline

  asm_show_attr_10:
    name: ASM Show Attr 10
    icon: mdi:plus-circle-outline

  asm_show_attr_11:
    name: ASM Show Attr 11
    icon: mdi:plus-circle-outline

  asm_show_attr_12:
    name: ASM Show Attr 12
    icon: mdi:plus-circle-outline

  asm_show_attr_13:
    name: ASM Show Attr 13
    icon: mdi:plus-circle-outline

  asm_show_attr_14:
    name: ASM Show Attr 14
    icon: mdi:plus-circle-outline

  asm_show_attr_15:
    name: ASM Show Attr 15
    icon: mdi:plus-circle-outline

  # Show additional part attribute slots
  asm_show_part_attr_2:
    name: ASM Show Part Attr 2
    icon: mdi:plus-circle-outline

  asm_show_part_attr_3:
    name: ASM Show Part Attr 3
    icon: mdi:plus-circle-outline

  asm_show_part_attr_4:
    name: ASM Show Part Attr 4
    icon: mdi:plus-circle-outline

  asm_show_part_attr_5:
    name: ASM Show Part Attr 5
    icon: mdi:plus-circle-outline

  asm_show_part_attr_6:
    name: ASM Show Part Attr 6
    icon: mdi:plus-circle-outline

  asm_show_part_attr_7:
    name: ASM Show Part Attr 7
    icon: mdi:plus-circle-outline

  asm_show_part_attr_8:
    name: ASM Show Part Attr 8
    icon: mdi:plus-circle-outline

  asm_show_part_attr_9:
    name: ASM Show Part Attr 9
    icon: mdi:plus-circle-outline

  asm_show_part_attr_10:
    name: ASM Show Part Attr 10
    icon: mdi:plus-circle-outline

  asm_show_part_attr_11:
    name: ASM Show Part Attr 11
    icon: mdi:plus-circle-outline

  asm_show_part_attr_12:
    name: ASM Show Part Attr 12
    icon: mdi:plus-circle-outline

  asm_show_part_attr_13:
    name: ASM Show Part Attr 13
    icon: mdi:plus-circle-outline

  asm_show_part_attr_14:
    name: ASM Show Part Attr 14
    icon: mdi:plus-circle-outline

  asm_show_part_attr_15:
    name: ASM Show Part Attr 15
    icon: mdi:plus-circle-outline

  # Show additional consume slots
  asm_show_consume_2:
    name: ASM Show Consume 2
    icon: mdi:plus-circle-outline

  asm_show_consume_3:
    name: ASM Show Consume 3
    icon: mdi:plus-circle-outline

  asm_show_consume_4:
    name: ASM Show Consume 4
    icon: mdi:plus-circle-outline

  asm_show_consume_5:
    name: ASM Show Consume 5
    icon: mdi:plus-circle-outline

  # Show additional asset assignment slots
  asm_show_asset_2:
    name: ASM Show Asset 2
    icon: mdi:plus-circle-outline

  asm_show_asset_3:
    name: ASM Show Asset 3
    icon: mdi:plus-circle-outline

  asm_show_asset_4:
    name: ASM Show Asset 4
    icon: mdi:plus-circle-outline

  asm_show_asset_5:
    name: ASM Show Asset 5
    icon: mdi:plus-circle-outline

#=============================================================================
# TEMPLATE SENSORS - Computed values for UI
#=============================================================================
template:
  - sensor:
      #-----------------------------------------------------------------------
      # Selected asset details
      #-----------------------------------------------------------------------
      - name: ASM Selected Asset
        unique_id: asm_selected_asset
        state: >
          {% set selected_name = states('input_select.asm_asset') %}
          {% if selected_name in ['Select Asset', 'unknown', 'unavailable', ''] %}
            none
          {% else %}
            {% set assets = state_attr('sensor.asm_data', 'assets') or {} %}
            {% for aid, a in assets.items() %}
              {% if a.name == selected_name %}
                {{ aid }}
              {% endif %}
            {% endfor %}
          {% endif %}
        attributes:
          id: >
            {% set selected_name = states('input_select.asm_asset') %}
            {% set assets = state_attr('sensor.asm_data', 'assets') or {} %}
            {% for aid, a in assets.items() %}
              {% if a.name == selected_name %}
                {{ aid }}
              {% endif %}
            {% endfor %}
          asset: >
            {% set selected_name = states('input_select.asm_asset') %}
            {% set assets = state_attr('sensor.asm_data', 'assets') or {} %}
            {% for aid, a in assets.items() %}
              {% if a.name == selected_name %}
                {{ a | tojson }}
              {% endif %}
            {% endfor %}

      #-----------------------------------------------------------------------
      # Selected part details
      #-----------------------------------------------------------------------
      - name: ASM Selected Part
        unique_id: asm_selected_part
        state: >
          {% set selected_name = states('input_select.asm_part') %}
          {% if selected_name in ['Select Part', 'unknown', 'unavailable', ''] %}
            none
          {% else %}
            {% set parts = state_attr('sensor.asm_data', 'parts') or {} %}
            {% for pid, p in parts.items() %}
              {% if p.name == selected_name %}
                {{ pid }}
              {% endif %}
            {% endfor %}
          {% endif %}
        attributes:
          id: >
            {% set selected_name = states('input_select.asm_part') %}
            {% set parts = state_attr('sensor.asm_data', 'parts') or {} %}
            {% for pid, p in parts.items() %}
              {% if p.name == selected_name %}
                {{ pid }}
              {% endif %}
            {% endfor %}
          part: >
            {% set selected_name = states('input_select.asm_part') %}
            {% set parts = state_attr('sensor.asm_data', 'parts') or {} %}
            {% for pid, p in parts.items() %}
              {% if p.name == selected_name %}
                {{ p | tojson }}
              {% endif %}
            {% endfor %}

      #-----------------------------------------------------------------------
      # Filtered parts for report view
      #-----------------------------------------------------------------------
      - name: ASM Filtered Parts
        unique_id: asm_filtered_parts
        state: >
          {% set filter_asset = states('input_select.asm_report_asset') %}
          {% set parts = state_attr('sensor.asm_data', 'parts') or {} %}
          {% set assets = state_attr('sensor.asm_data', 'assets') or {} %}

          {% if filter_asset in ['All Assets', 'unknown', 'unavailable', ''] %}
            {{ parts | length }}
          {% else %}
            {# Find asset ID from name #}
            {% set ns = namespace(asset_id='') %}
            {% for aid, a in assets.items() %}
              {% if a.name == filter_asset %}
                {% set ns.asset_id = aid %}
              {% endif %}
            {% endfor %}

            {% set count = namespace(val=0) %}
            {% for pid, p in parts.items() %}
              {% if p.universal or ns.asset_id in (p.applicable_assets | default([])) %}
                {% set count.val = count.val + 1 %}
              {% endif %}
            {% endfor %}
            {{ count.val }}
          {% endif %}
        attributes:
          parts: >
            {% set filter_asset = states('input_select.asm_report_asset') %}
            {% set parts = state_attr('sensor.asm_data', 'parts') or {} %}
            {% set assets = state_attr('sensor.asm_data', 'assets') or {} %}

            {% if filter_asset in ['All Assets', 'unknown', 'unavailable', ''] %}
              {{ parts | tojson }}
            {% else %}
              {% set ns = namespace(asset_id='') %}
              {% for aid, a in assets.items() %}
                {% if a.name == filter_asset %}
                  {% set ns.asset_id = aid %}
                {% endif %}
              {% endfor %}

              {% set filtered = namespace(items={}) %}
              {% for pid, p in parts.items() %}
                {% if p.universal or ns.asset_id in (p.applicable_assets | default([])) %}
                  {% set filtered.items = dict(filtered.items, **{pid: p}) %}
                {% endif %}
              {% endfor %}
              {{ filtered.items | tojson }}
            {% endif %}

      #-----------------------------------------------------------------------
      # Low stock count
      #-----------------------------------------------------------------------
      - name: ASM Low Stock Count
        unique_id: asm_low_stock_count
        icon: mdi:alert
        state: >
          {{ state_attr('sensor.asm_data', 'low_stock_count') | default(0) }}

      #-----------------------------------------------------------------------
      # Selected service event details
      #-----------------------------------------------------------------------
      - name: ASM Selected Service Event
        unique_id: asm_selected_service_event
        state: >
          {% set selected_label = states('input_select.asm_service_event') %}
          {% if selected_label in ['Select Event', 'unknown', 'unavailable', ''] %}
            none
          {% else %}
            {% set events = state_attr('sensor.asm_data', 'recent_events') or [] %}
            {% set event_id_to_label = state_attr('sensor.asm_data', 'event_id_to_label') or {} %}
            {% for e in events %}
              {% if event_id_to_label.get(e.id, '') == selected_label %}
                {{ e.id }}
              {% endif %}
            {% endfor %}
          {% endif %}
        attributes:
          event: >
            {% set selected_label = states('input_select.asm_service_event') %}
            {% set events = state_attr('sensor.asm_data', 'recent_events') or [] %}
            {% set event_id_to_label = state_attr('sensor.asm_data', 'event_id_to_label') or {} %}
            {% for e in events %}
              {% if event_id_to_label.get(e.id, '') == selected_label %}
                {{ e | tojson }}
              {% endif %}
            {% endfor %}

#=============================================================================
# AUTOMATIONS - Keep dropdowns in sync
#=============================================================================
automation:
  #---------------------------------------------------------------------------
  # Update asset dropdown on data change
  #---------------------------------------------------------------------------
  - id: asm_update_asset_options
    alias: "ASM: Update Asset Options"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.asm_data
      - platform: homeassistant
        event: start
    action:
      - delay: "00:00:01"
      - variables:
          asset_names: "{{ state_attr('sensor.asm_data', 'asset_names') or [] }}"
      - service: input_select.set_options
        target:
          entity_id:
            - input_select.asm_asset
            - input_select.asm_service_asset
        data:
          options: "{{ ['Select Asset'] + asset_names }}"
      - service: input_select.set_options
        target:
          entity_id: input_select.asm_report_asset
        data:
          options: "{{ ['All Assets'] + asset_names }}"
      # Update part-to-asset dropdowns
      - service: input_select.set_options
        target:
          entity_id:
            - input_select.asm_part_asset_1
            - input_select.asm_part_asset_2
            - input_select.asm_part_asset_3
            - input_select.asm_part_asset_4
            - input_select.asm_part_asset_5
        data:
          options: "{{ ['None'] + asset_names }}"
      # Reset editor modes to View on startup
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_editor_mode
        data:
          option: "View"
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_part_editor_mode
        data:
          option: "View"

  #---------------------------------------------------------------------------
  # Update part dropdown on data change
  #---------------------------------------------------------------------------
  - id: asm_update_part_options
    alias: "ASM: Update Part Options"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.asm_data
      - platform: homeassistant
        event: start
    action:
      - delay: "00:00:01"
      - variables:
          part_names: "{{ state_attr('sensor.asm_data', 'part_names') or [] }}"
      - service: input_select.set_options
        target:
          entity_id: input_select.asm_part
        data:
          options: "{{ ['Select Part'] + part_names }}"
      # Update consume part dropdowns
      - service: input_select.set_options
        target:
          entity_id:
            - input_select.asm_consume_part_1
            - input_select.asm_consume_part_2
            - input_select.asm_consume_part_3
            - input_select.asm_consume_part_4
            - input_select.asm_consume_part_5
        data:
          options: "{{ ['None'] + part_names }}"

  #---------------------------------------------------------------------------
  # Update service event dropdown on data change
  #---------------------------------------------------------------------------
  - id: asm_update_service_event_options
    alias: "ASM: Update Service Event Options"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.asm_data
      - platform: homeassistant
        event: start
    action:
      - delay: "00:00:01"
      - variables:
          event_labels: "{{ state_attr('sensor.asm_data', 'event_labels') or [] }}"
      - service: input_select.set_options
        target:
          entity_id: input_select.asm_service_event
        data:
          options: "{{ ['Select Event'] + event_labels }}"

#=============================================================================
# SCRIPTS - User actions
#=============================================================================
script:
  #---------------------------------------------------------------------------
  # Start adding a new asset (clears form and sets mode)
  #---------------------------------------------------------------------------
  asm_start_add_asset:
    alias: "ASM: Start Add Asset"
    mode: single
    sequence:
      - service: script.asm_clear_asset_form
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_editor_mode
        data:
          option: "Add New"

  #---------------------------------------------------------------------------
  # Add new asset
  #---------------------------------------------------------------------------
  asm_add_asset:
    alias: "ASM: Add Asset"
    mode: single
    sequence:
      - variables:
          name: "{{ states('input_text.asm_asset_name') | trim }}"
          category: "{{ states('input_select.asm_asset_category') }}"
          # Build attributes JSON (15 slots)
          attrs_json: >
            {% set ns = namespace(attrs={}) %}
            {% for i in range(1, 16) %}
              {% set an = states('input_text.asm_attr_' ~ i ~ '_name') | trim %}
              {% set av = states('input_text.asm_attr_' ~ i ~ '_value') | trim %}
              {% if an %}{% set ns.attrs = dict(ns.attrs, **{an: av}) %}{% endif %}
            {% endfor %}
            {{ ns.attrs | tojson }}

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ name == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Add Asset"
                  message: "Asset name is required."
              - stop: "No name"

      - service: shell_command.asm_add_asset
        data:
          name: "{{ name }}"
          category: "{{ category }}"
          attributes: "{{ attrs_json }}"

      - service: script.asm_clear_asset_form

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Add Asset"
          message: "Asset '{{ name }}' added."

  #---------------------------------------------------------------------------
  # Load asset into editor
  #---------------------------------------------------------------------------
  asm_load_asset:
    alias: "ASM: Load Asset"
    mode: single
    sequence:
      - variables:
          asset_id_raw: "{{ states('sensor.asm_selected_asset') }}"
          asset_id: "{{ (asset_id_raw or '') | string }}"
          asset_id_lc: "{{ (asset_id_raw or '') | string | lower }}"
          assets: "{{ state_attr('sensor.asm_data', 'assets') or {} }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ asset_id_lc in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Load Asset"
                  message: "Select an asset first."
              - stop: "No asset"

          - conditions:
              - condition: template
                value_template: "{{ asset_id not in assets }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Load Asset"
                  message: "Selected asset '{{ asset_id }}' was not found."
              - stop: "Asset not found"

      - variables:
          a: "{{ (state_attr('sensor.asm_data', 'assets') or {}).get(asset_id, {}) }}"
          attrs: "{{ a.get('attributes', {}) if a.get('attributes') is mapping else {} }}"
          attr_keys: "{{ (attrs.keys() | list | sort) }}"

      - service: input_select.select_option
        target:
          entity_id: input_select.asm_editor_mode
        data:
          option: "Edit Existing"

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_asset_name
        data:
          value: "{{ a.get('name', '') | string }}"

      - variables:
          cat_options: "{{ state_attr('input_select.asm_asset_category', 'options') or [] }}"
          desired_cat: "{{ (a.get('category') or 'Tractor') | string }}"
          safe_cat: >-
            {% if cat_options | length == 0 %}
              Tractor
            {% elif desired_cat in cat_options %}
              {{ desired_cat }}
            {% else %}
              {{ cat_options[0] }}
            {% endif %}
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_asset_category
        data:
          option: "{{ safe_cat | trim }}"

      # Reset all show toggles first
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.asm_show_attr_2
            - input_boolean.asm_show_attr_3
            - input_boolean.asm_show_attr_4
            - input_boolean.asm_show_attr_5
            - input_boolean.asm_show_attr_6
            - input_boolean.asm_show_attr_7
            - input_boolean.asm_show_attr_8
            - input_boolean.asm_show_attr_9
            - input_boolean.asm_show_attr_10
            - input_boolean.asm_show_attr_11
            - input_boolean.asm_show_attr_12
            - input_boolean.asm_show_attr_13
            - input_boolean.asm_show_attr_14
            - input_boolean.asm_show_attr_15

      # Load attributes (15 slots) - re-fetch to ensure scope
      - variables:
          asset_data: "{{ (state_attr('sensor.asm_data', 'assets') or {}).get(asset_id, {}) }}"
          attr_data: "{{ asset_data.get('attributes', {}) if asset_data.get('attributes') is mapping else {} }}"
          attr_list: "{{ (attr_data.keys() | list | sort) }}"

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_1_name
        data:
          value: "{{ attr_list[0] if attr_list | length > 0 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_1_value
        data:
          value: "{{ attr_data.get(attr_list[0], '') if attr_list | length > 0 else '' }}"

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_2_name
        data:
          value: "{{ attr_list[1] if attr_list | length > 1 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_2_value
        data:
          value: "{{ attr_data.get(attr_list[1], '') if attr_list | length > 1 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 1 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_2

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_3_name
        data:
          value: "{{ attr_list[2] if attr_list | length > 2 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_3_value
        data:
          value: "{{ attr_data.get(attr_list[2], '') if attr_list | length > 2 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 2 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_3

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_4_name
        data:
          value: "{{ attr_list[3] if attr_list | length > 3 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_4_value
        data:
          value: "{{ attr_data.get(attr_list[3], '') if attr_list | length > 3 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 3 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_4

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_5_name
        data:
          value: "{{ attr_list[4] if attr_list | length > 4 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_5_value
        data:
          value: "{{ attr_data.get(attr_list[4], '') if attr_list | length > 4 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 4 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_5

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_6_name
        data:
          value: "{{ attr_list[5] if attr_list | length > 5 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_6_value
        data:
          value: "{{ attr_data.get(attr_list[5], '') if attr_list | length > 5 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 5 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_6

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_7_name
        data:
          value: "{{ attr_list[6] if attr_list | length > 6 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_7_value
        data:
          value: "{{ attr_data.get(attr_list[6], '') if attr_list | length > 6 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 6 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_7

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_8_name
        data:
          value: "{{ attr_list[7] if attr_list | length > 7 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_8_value
        data:
          value: "{{ attr_data.get(attr_list[7], '') if attr_list | length > 7 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 7 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_8

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_9_name
        data:
          value: "{{ attr_list[8] if attr_list | length > 8 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_9_value
        data:
          value: "{{ attr_data.get(attr_list[8], '') if attr_list | length > 8 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 8 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_9

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_10_name
        data:
          value: "{{ attr_list[9] if attr_list | length > 9 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_10_value
        data:
          value: "{{ attr_data.get(attr_list[9], '') if attr_list | length > 9 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 9 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_10

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_11_name
        data:
          value: "{{ attr_list[10] if attr_list | length > 10 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_11_value
        data:
          value: "{{ attr_data.get(attr_list[10], '') if attr_list | length > 10 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 10 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_11

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_12_name
        data:
          value: "{{ attr_list[11] if attr_list | length > 11 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_12_value
        data:
          value: "{{ attr_data.get(attr_list[11], '') if attr_list | length > 11 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 11 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_12

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_13_name
        data:
          value: "{{ attr_list[12] if attr_list | length > 12 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_13_value
        data:
          value: "{{ attr_data.get(attr_list[12], '') if attr_list | length > 12 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 12 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_13

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_14_name
        data:
          value: "{{ attr_list[13] if attr_list | length > 13 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_14_value
        data:
          value: "{{ attr_data.get(attr_list[13], '') if attr_list | length > 13 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 13 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_14

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_15_name
        data:
          value: "{{ attr_list[14] if attr_list | length > 14 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_attr_15_value
        data:
          value: "{{ attr_data.get(attr_list[14], '') if attr_list | length > 14 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_list | length > 14 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_attr_15

      - service: persistent_notification.create
        data:
          title: "ASM Load Asset"
          message: "Loaded '{{ asset_data.get('name', asset_id) }}'."

  #---------------------------------------------------------------------------
  # Save asset (edit existing)
  #---------------------------------------------------------------------------
  asm_save_asset:
    alias: "ASM: Save Asset"
    mode: single
    sequence:
      - variables:
          mode: "{{ states('input_select.asm_editor_mode') }}"
          asset_id: "{{ states('sensor.asm_selected_asset') }}"
          name: "{{ states('input_text.asm_asset_name') | trim }}"
          category: "{{ states('input_select.asm_asset_category') }}"
          # Build attributes JSON (15 slots)
          attrs_json: >
            {% set ns = namespace(attrs={}) %}
            {% for i in range(1, 16) %}
              {% set an = states('input_text.asm_attr_' ~ i ~ '_name') | trim %}
              {% set av = states('input_text.asm_attr_' ~ i ~ '_value') | trim %}
              {% if an %}{% set ns.attrs = dict(ns.attrs, **{an: av}) %}{% endif %}
            {% endfor %}
            {{ ns.attrs | tojson }}

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ 'Add' in mode }}"
            sequence:
              - service: script.asm_add_asset
              - stop: "Delegated to add"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ asset_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Save Asset"
                  message: "No asset loaded. Use Load first."
              - stop: "No asset"

      - service: shell_command.asm_edit_asset
        data:
          asset_id: "{{ asset_id }}"
          name: "{{ name }}"
          category: "{{ category }}"
          attributes: "{{ attrs_json }}"

      - service: script.asm_clear_asset_form

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Save Asset"
          message: "Asset '{{ name }}' updated."

  #---------------------------------------------------------------------------
  # Clear asset form
  #---------------------------------------------------------------------------
  asm_clear_asset_form:
    alias: "ASM: Clear Asset Form"
    mode: single
    sequence:
      - service: input_text.set_value
        target:
          entity_id:
            - input_text.asm_asset_name
            - input_text.asm_attr_1_name
            - input_text.asm_attr_1_value
            - input_text.asm_attr_2_name
            - input_text.asm_attr_2_value
            - input_text.asm_attr_3_name
            - input_text.asm_attr_3_value
            - input_text.asm_attr_4_name
            - input_text.asm_attr_4_value
            - input_text.asm_attr_5_name
            - input_text.asm_attr_5_value
            - input_text.asm_attr_6_name
            - input_text.asm_attr_6_value
            - input_text.asm_attr_7_name
            - input_text.asm_attr_7_value
            - input_text.asm_attr_8_name
            - input_text.asm_attr_8_value
            - input_text.asm_attr_9_name
            - input_text.asm_attr_9_value
            - input_text.asm_attr_10_name
            - input_text.asm_attr_10_value
            - input_text.asm_attr_11_name
            - input_text.asm_attr_11_value
            - input_text.asm_attr_12_name
            - input_text.asm_attr_12_value
            - input_text.asm_attr_13_name
            - input_text.asm_attr_13_value
            - input_text.asm_attr_14_name
            - input_text.asm_attr_14_value
            - input_text.asm_attr_15_name
            - input_text.asm_attr_15_value
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_editor_mode
        data:
          option: "Add New"
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.asm_show_attr_2
            - input_boolean.asm_show_attr_3
            - input_boolean.asm_show_attr_4
            - input_boolean.asm_show_attr_5
            - input_boolean.asm_show_attr_6
            - input_boolean.asm_show_attr_7
            - input_boolean.asm_show_attr_8
            - input_boolean.asm_show_attr_9
            - input_boolean.asm_show_attr_10
            - input_boolean.asm_show_attr_11
            - input_boolean.asm_show_attr_12
            - input_boolean.asm_show_attr_13
            - input_boolean.asm_show_attr_14
            - input_boolean.asm_show_attr_15
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_editor_mode
        data:
          option: "View"

  #---------------------------------------------------------------------------
  # Delete asset
  #---------------------------------------------------------------------------
  asm_delete_asset:
    alias: "ASM: Delete Asset"
    mode: single
    sequence:
      - variables:
          asset_id: "{{ states('sensor.asm_selected_asset') }}"
          assets: "{{ state_attr('sensor.asm_data', 'assets') or {} }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ asset_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Delete Asset"
                  message: "Select an asset first."
              - stop: "No asset"

      - variables:
          asset_name: "{{ assets.get(asset_id, {}).get('name', asset_id) }}"

      - service: shell_command.asm_delete_asset
        data:
          asset_id: "{{ asset_id }}"

      - service: script.asm_clear_asset_form

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Delete Asset"
          message: "Asset '{{ asset_name }}' deleted."

  #---------------------------------------------------------------------------
  # Delete part
  #---------------------------------------------------------------------------
  asm_delete_part:
    alias: "ASM: Delete Part"
    mode: single
    sequence:
      - variables:
          part_id: "{{ states('sensor.asm_selected_part') }}"
          parts: "{{ state_attr('sensor.asm_data', 'parts') or {} }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ part_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Delete Part"
                  message: "Select a part first."
              - stop: "No part"

      - variables:
          part_name: "{{ parts.get(part_id, {}).get('name', part_id) }}"

      - service: shell_command.asm_delete_part
        data:
          part_id: "{{ part_id }}"

      - service: script.asm_clear_part_form

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Delete Part"
          message: "Part '{{ part_name }}' deleted."

  #---------------------------------------------------------------------------
  # Start adding a new part (clears form and sets mode)
  #---------------------------------------------------------------------------
  asm_start_add_part:
    alias: "ASM: Start Add Part"
    mode: single
    sequence:
      - service: script.asm_clear_part_form
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_part_editor_mode
        data:
          option: "Add New"

  #---------------------------------------------------------------------------
  # Add new part
  #---------------------------------------------------------------------------
  asm_add_part:
    alias: "ASM: Add Part"
    mode: single
    sequence:
      - variables:
          name: "{{ states('input_text.asm_part_name') | trim }}"
          part_number: "{{ states('input_text.asm_part_number') | trim }}"
          category: "{{ states('input_select.asm_part_category') }}"
          unit: "{{ states('input_select.asm_part_unit') }}"
          stock: "{{ states('input_number.asm_part_stock') | float(0) }}"
          min_stock: "{{ states('input_number.asm_part_min_stock') | float(0) }}"
          universal: "{{ is_state('input_boolean.asm_universal_part', 'on') }}"
          assets: "{{ state_attr('sensor.asm_data', 'assets') or {} }}"
          # Build assets array from selections
          assets_json: >
            {% set arr = [] %}
            {% set a1 = states('input_select.asm_part_asset_1') %}
            {% if a1 != 'None' %}
              {% for aid, a in assets.items() if a.name == a1 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a2 = states('input_select.asm_part_asset_2') %}
            {% if a2 != 'None' %}
              {% for aid, a in assets.items() if a.name == a2 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a3 = states('input_select.asm_part_asset_3') %}
            {% if a3 != 'None' %}
              {% for aid, a in assets.items() if a.name == a3 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a4 = states('input_select.asm_part_asset_4') %}
            {% if a4 != 'None' %}
              {% for aid, a in assets.items() if a.name == a4 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a5 = states('input_select.asm_part_asset_5') %}
            {% if a5 != 'None' %}
              {% for aid, a in assets.items() if a.name == a5 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {{ arr | tojson }}
          # Build part attributes (15 slots)
          attrs_json: >
            {% set ns = namespace(attrs={}) %}
            {% for i in range(1, 16) %}
              {% set an = states('input_text.asm_part_attr_' ~ i ~ '_name') | trim %}
              {% set av = states('input_text.asm_part_attr_' ~ i ~ '_value') | trim %}
              {% if an %}{% set ns.attrs = dict(ns.attrs, **{an: av}) %}{% endif %}
            {% endfor %}
            {{ ns.attrs | tojson }}

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ name == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Add Part"
                  message: "Part name is required."
              - stop: "No name"

      - service: shell_command.asm_add_part
        data:
          name: "{{ name }}"
          part_number: "{{ part_number }}"
          category: "{{ category }}"
          unit: "{{ unit }}"
          stock: "{{ stock }}"
          min_stock: "{{ min_stock }}"
          assets: "{{ assets_json }}"
          universal: "{{ 'true' if universal else 'false' }}"
          attributes: "{{ attrs_json }}"

      - service: script.asm_clear_part_form

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Add Part"
          message: "Part '{{ name }}' added."

  #---------------------------------------------------------------------------
  # Save part (edit existing or add new based on mode)
  #---------------------------------------------------------------------------
  asm_save_part:
    alias: "ASM: Save Part"
    mode: single
    sequence:
      - variables:
          mode: "{{ states('input_select.asm_part_editor_mode') }}"
          part_id: "{{ states('sensor.asm_selected_part') }}"
          name: "{{ states('input_text.asm_part_name') | trim }}"
          part_number: "{{ states('input_text.asm_part_number') | trim }}"
          category: "{{ states('input_select.asm_part_category') }}"
          unit: "{{ states('input_select.asm_part_unit') }}"
          min_stock: "{{ states('input_number.asm_part_min_stock') | float(0) }}"
          universal: "{{ is_state('input_boolean.asm_universal_part', 'on') }}"
          assets: "{{ state_attr('sensor.asm_data', 'assets') or {} }}"
          # Build assets array from selections
          assets_json: >
            {% set arr = [] %}
            {% set a1 = states('input_select.asm_part_asset_1') %}
            {% if a1 != 'None' %}
              {% for aid, a in assets.items() if a.name == a1 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a2 = states('input_select.asm_part_asset_2') %}
            {% if a2 != 'None' %}
              {% for aid, a in assets.items() if a.name == a2 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a3 = states('input_select.asm_part_asset_3') %}
            {% if a3 != 'None' %}
              {% for aid, a in assets.items() if a.name == a3 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a4 = states('input_select.asm_part_asset_4') %}
            {% if a4 != 'None' %}
              {% for aid, a in assets.items() if a.name == a4 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {% set a5 = states('input_select.asm_part_asset_5') %}
            {% if a5 != 'None' %}
              {% for aid, a in assets.items() if a.name == a5 %}
                {% set arr = arr + [aid] %}
              {% endfor %}
            {% endif %}
            {{ arr | tojson }}
          # Build part attributes (15 slots)
          attrs_json: >
            {% set ns = namespace(attrs={}) %}
            {% for i in range(1, 16) %}
              {% set an = states('input_text.asm_part_attr_' ~ i ~ '_name') | trim %}
              {% set av = states('input_text.asm_part_attr_' ~ i ~ '_value') | trim %}
              {% if an %}{% set ns.attrs = dict(ns.attrs, **{an: av}) %}{% endif %}
            {% endfor %}
            {{ ns.attrs | tojson }}

      - choose:
          # If in Add mode, delegate to add script
          - conditions:
              - condition: template
                value_template: "{{ 'Add' in mode }}"
            sequence:
              - service: script.asm_add_part
              - stop: "Delegated to add"

      # Edit mode - validate
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ part_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Save Part"
                  message: "No part loaded. Use Load first."
              - stop: "No part"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ name == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Save Part"
                  message: "Part name is required."
              - stop: "No name"

      - service: shell_command.asm_edit_part
        data:
          part_id: "{{ part_id }}"
          name: "{{ name }}"
          part_number: "{{ part_number }}"
          category: "{{ category }}"
          unit: "{{ unit }}"
          min_stock: "{{ min_stock }}"
          assets: "{{ assets_json }}"
          universal: "{{ 'true' if universal else 'false' }}"
          attributes: "{{ attrs_json }}"

      - service: script.asm_clear_part_form

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Save Part"
          message: "Part '{{ name }}' updated."

  #---------------------------------------------------------------------------
  # Clear part form
  #---------------------------------------------------------------------------
  asm_clear_part_form:
    alias: "ASM: Clear Part Form"
    mode: single
    sequence:
      - service: input_text.set_value
        target:
          entity_id:
            - input_text.asm_part_name
            - input_text.asm_part_number
            - input_text.asm_part_attr_1_name
            - input_text.asm_part_attr_1_value
            - input_text.asm_part_attr_2_name
            - input_text.asm_part_attr_2_value
            - input_text.asm_part_attr_3_name
            - input_text.asm_part_attr_3_value
            - input_text.asm_part_attr_4_name
            - input_text.asm_part_attr_4_value
            - input_text.asm_part_attr_5_name
            - input_text.asm_part_attr_5_value
            - input_text.asm_part_attr_6_name
            - input_text.asm_part_attr_6_value
            - input_text.asm_part_attr_7_name
            - input_text.asm_part_attr_7_value
            - input_text.asm_part_attr_8_name
            - input_text.asm_part_attr_8_value
            - input_text.asm_part_attr_9_name
            - input_text.asm_part_attr_9_value
            - input_text.asm_part_attr_10_name
            - input_text.asm_part_attr_10_value
            - input_text.asm_part_attr_11_name
            - input_text.asm_part_attr_11_value
            - input_text.asm_part_attr_12_name
            - input_text.asm_part_attr_12_value
            - input_text.asm_part_attr_13_name
            - input_text.asm_part_attr_13_value
            - input_text.asm_part_attr_14_name
            - input_text.asm_part_attr_14_value
            - input_text.asm_part_attr_15_name
            - input_text.asm_part_attr_15_value
        data:
          value: ""
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.asm_part_stock
            - input_number.asm_part_min_stock
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.asm_part_asset_1
            - input_select.asm_part_asset_2
            - input_select.asm_part_asset_3
            - input_select.asm_part_asset_4
            - input_select.asm_part_asset_5
        data:
          option: "None"
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.asm_universal_part
            - input_boolean.asm_show_part_attr_2
            - input_boolean.asm_show_part_attr_3
            - input_boolean.asm_show_part_attr_4
            - input_boolean.asm_show_part_attr_5
            - input_boolean.asm_show_part_attr_6
            - input_boolean.asm_show_part_attr_7
            - input_boolean.asm_show_part_attr_8
            - input_boolean.asm_show_part_attr_9
            - input_boolean.asm_show_part_attr_10
            - input_boolean.asm_show_part_attr_11
            - input_boolean.asm_show_part_attr_12
            - input_boolean.asm_show_part_attr_13
            - input_boolean.asm_show_part_attr_14
            - input_boolean.asm_show_part_attr_15
            - input_boolean.asm_show_asset_2
            - input_boolean.asm_show_asset_3
            - input_boolean.asm_show_asset_4
            - input_boolean.asm_show_asset_5
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_part_editor_mode
        data:
          option: "View"

#---------------------------------------------------------------------------
# Load part into editor
#---------------------------------------------------------------------------
  asm_load_part:
    alias: "ASM: Load Part"
    mode: single
    sequence:
      - variables:
          part_id_raw: "{{ states('sensor.asm_selected_part') }}"
          part_id: "{{ (part_id_raw or '') | string }}"
          part_id_lc: "{{ (part_id_raw or '') | string | lower }}"
          parts: "{{ state_attr('sensor.asm_data', 'parts') or {} }}"
          assets: "{{ state_attr('sensor.asm_data', 'assets') or {} }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ part_id_lc in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Load Part"
                  message: "Select a part first."
              - stop: "No part selected"

          - conditions:
              - condition: template
                value_template: "{{ part_id not in parts }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Load Part"
                  message: "Selected part '{{ part_id }}' was not found in asm_data.parts."
              - stop: "Part not found"

      - variables:
          p: "{{ parts.get(part_id, {}) }}"
          attrs: "{{ p.get('attributes', {}) if p.get('attributes', {}) is mapping else {} }}"
          attr_keys: "{{ (attrs.keys() | list | sort) }}"
          applicable: "{{ p.get('applicable_assets', []) or [] }}"

      # Reset toggles
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.asm_show_asset_2
            - input_boolean.asm_show_asset_3
            - input_boolean.asm_show_asset_4
            - input_boolean.asm_show_asset_5
            - input_boolean.asm_show_part_attr_2
            - input_boolean.asm_show_part_attr_3
            - input_boolean.asm_show_part_attr_4
            - input_boolean.asm_show_part_attr_5
            - input_boolean.asm_show_part_attr_6
            - input_boolean.asm_show_part_attr_7
            - input_boolean.asm_show_part_attr_8
            - input_boolean.asm_show_part_attr_9
            - input_boolean.asm_show_part_attr_10
            - input_boolean.asm_show_part_attr_11
            - input_boolean.asm_show_part_attr_12
            - input_boolean.asm_show_part_attr_13
            - input_boolean.asm_show_part_attr_14
            - input_boolean.asm_show_part_attr_15

      # Basic fields
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_name
        data:
          value: "{{ (p.get('name') or '') | string }}"

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_number
        data:
          value: "{{ (p.get('part_number') or '') | string }}"

      # Category
      - variables:
          cat_options: "{{ state_attr('input_select.asm_part_category', 'options') or [] }}"
          desired_cat: "{{ (p.get('category') or 'Filter') | string }}"
          safe_cat: >-
            {% if cat_options | length == 0 %}
              ''
            {% elif desired_cat in cat_options %}
              {{ desired_cat }}
            {% else %}
              {{ cat_options[0] }}
            {% endif %}
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ cat_options | length > 0 and (safe_cat | string) | length > 0 }}"
            sequence:
              - service: input_select.select_option
                target:
                  entity_id: input_select.asm_part_category
                data:
                  option: "{{ safe_cat | string }}"

      # Unit
      - variables:
          unit_options: "{{ state_attr('input_select.asm_part_unit', 'options') or [] }}"
          desired_unit: "{{ (p.get('unit') or 'ea') | string }}"
          safe_unit: >-
            {% if unit_options | length == 0 %}
              ''
            {% elif desired_unit in unit_options %}
              {{ desired_unit }}
            {% else %}
              {{ unit_options[0] }}
            {% endif %}
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ unit_options | length > 0 and (safe_unit | string) | length > 0 }}"
            sequence:
              - service: input_select.select_option
                target:
                  entity_id: input_select.asm_part_unit
                data:
                  option: "{{ safe_unit | string }}"

      - service: input_number.set_value
        target:
          entity_id: input_number.asm_part_min_stock
        data:
          value: "{{ p.get('min_stock', 0) | float(0) }}"

      - service: "input_boolean.turn_{{ 'on' if (p.get('universal', false) | bool) else 'off' }}"
        target:
          entity_id: input_boolean.asm_universal_part

      # Set editor mode to Edit Existing
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_part_editor_mode
        data:
          option: "Edit Existing"

      # -----------------------------------------------------------------------
      # Assets - restore applicable assets from part data
      # -----------------------------------------------------------------------
      - variables:
          asset_id_to_name: "{{ state_attr('sensor.asm_data', 'asset_id_to_name') or {} }}"
          # Build list of asset names from IDs
          asset_name_1: >
            {% if applicable | length > 0 %}
              {{ asset_id_to_name.get(applicable[0], '') }}
            {% else %}
              None
            {% endif %}
          asset_name_2: >
            {% if applicable | length > 1 %}
              {{ asset_id_to_name.get(applicable[1], '') }}
            {% else %}
              None
            {% endif %}
          asset_name_3: >
            {% if applicable | length > 2 %}
              {{ asset_id_to_name.get(applicable[2], '') }}
            {% else %}
              None
            {% endif %}
          asset_name_4: >
            {% if applicable | length > 3 %}
              {{ asset_id_to_name.get(applicable[3], '') }}
            {% else %}
              None
            {% endif %}
          asset_name_5: >
            {% if applicable | length > 4 %}
              {{ asset_id_to_name.get(applicable[4], '') }}
            {% else %}
              None
            {% endif %}

      # Reset all to None first
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.asm_part_asset_1
            - input_select.asm_part_asset_2
            - input_select.asm_part_asset_3
            - input_select.asm_part_asset_4
            - input_select.asm_part_asset_5
        data:
          option: "None"

      # Set Asset 1 if applicable
      - if:
          - condition: template
            value_template: "{{ asset_name_1 | trim not in ['', 'None'] }}"
        then:
          - service: input_select.select_option
            target:
              entity_id: input_select.asm_part_asset_1
            data:
              option: "{{ asset_name_1 | trim }}"

      # Set Asset 2 if applicable
      - if:
          - condition: template
            value_template: "{{ asset_name_2 | trim not in ['', 'None'] }}"
        then:
          - service: input_select.select_option
            target:
              entity_id: input_select.asm_part_asset_2
            data:
              option: "{{ asset_name_2 | trim }}"
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_2

      # Set Asset 3 if applicable
      - if:
          - condition: template
            value_template: "{{ asset_name_3 | trim not in ['', 'None'] }}"
        then:
          - service: input_select.select_option
            target:
              entity_id: input_select.asm_part_asset_3
            data:
              option: "{{ asset_name_3 | trim }}"
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_2
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_3

      # Set Asset 4 if applicable
      - if:
          - condition: template
            value_template: "{{ asset_name_4 | trim not in ['', 'None'] }}"
        then:
          - service: input_select.select_option
            target:
              entity_id: input_select.asm_part_asset_4
            data:
              option: "{{ asset_name_4 | trim }}"
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_2
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_3
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_4

      # Set Asset 5 if applicable
      - if:
          - condition: template
            value_template: "{{ asset_name_5 | trim not in ['', 'None'] }}"
        then:
          - service: input_select.select_option
            target:
              entity_id: input_select.asm_part_asset_5
            data:
              option: "{{ asset_name_5 | trim }}"
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_2
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_3
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_4
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_asset_5

      # -----------------------------------------------------------------------
      # Attributes
      # -----------------------------------------------------------------------
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_1_name
        data:
          value: "{{ attr_keys[0] if attr_keys | length > 0 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_1_value
        data:
          value: "{{ attrs.get(attr_keys[0], '') if attr_keys | length > 0 else '' }}"

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_2_name
        data:
          value: "{{ attr_keys[1] if attr_keys | length > 1 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_2_value
        data:
          value: "{{ attrs.get(attr_keys[1], '') if attr_keys | length > 1 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 1 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_2

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_3_name
        data:
          value: "{{ attr_keys[2] if attr_keys | length > 2 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_3_value
        data:
          value: "{{ attrs.get(attr_keys[2], '') if attr_keys | length > 2 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 2 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_3

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_4_name
        data:
          value: "{{ attr_keys[3] if attr_keys | length > 3 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_4_value
        data:
          value: "{{ attrs.get(attr_keys[3], '') if attr_keys | length > 3 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 3 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_4

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_5_name
        data:
          value: "{{ attr_keys[4] if attr_keys | length > 4 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_5_value
        data:
          value: "{{ attrs.get(attr_keys[4], '') if attr_keys | length > 4 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 4 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_5

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_6_name
        data:
          value: "{{ attr_keys[5] if attr_keys | length > 5 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_6_value
        data:
          value: "{{ attrs.get(attr_keys[5], '') if attr_keys | length > 5 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 5 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_6

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_7_name
        data:
          value: "{{ attr_keys[6] if attr_keys | length > 6 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_7_value
        data:
          value: "{{ attrs.get(attr_keys[6], '') if attr_keys | length > 6 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 6 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_7

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_8_name
        data:
          value: "{{ attr_keys[7] if attr_keys | length > 7 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_8_value
        data:
          value: "{{ attrs.get(attr_keys[7], '') if attr_keys | length > 7 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 7 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_8

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_9_name
        data:
          value: "{{ attr_keys[8] if attr_keys | length > 8 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_9_value
        data:
          value: "{{ attrs.get(attr_keys[8], '') if attr_keys | length > 8 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 8 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_9

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_10_name
        data:
          value: "{{ attr_keys[9] if attr_keys | length > 9 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_10_value
        data:
          value: "{{ attrs.get(attr_keys[9], '') if attr_keys | length > 9 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 9 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_10

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_11_name
        data:
          value: "{{ attr_keys[10] if attr_keys | length > 10 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_11_value
        data:
          value: "{{ attrs.get(attr_keys[10], '') if attr_keys | length > 10 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 10 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_11

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_12_name
        data:
          value: "{{ attr_keys[11] if attr_keys | length > 11 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_12_value
        data:
          value: "{{ attrs.get(attr_keys[11], '') if attr_keys | length > 11 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 11 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_12

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_13_name
        data:
          value: "{{ attr_keys[12] if attr_keys | length > 12 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_13_value
        data:
          value: "{{ attrs.get(attr_keys[12], '') if attr_keys | length > 12 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 12 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_13

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_14_name
        data:
          value: "{{ attr_keys[13] if attr_keys | length > 13 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_14_value
        data:
          value: "{{ attrs.get(attr_keys[13], '') if attr_keys | length > 13 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 13 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_14

      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_15_name
        data:
          value: "{{ attr_keys[14] if attr_keys | length > 14 else '' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.asm_part_attr_15_value
        data:
          value: "{{ attrs.get(attr_keys[14], '') if attr_keys | length > 14 else '' }}"
      - if:
          - condition: template
            value_template: "{{ attr_keys | length > 14 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.asm_show_part_attr_15

      - service: persistent_notification.create
        data:
          title: "ASM Load Part"
          message: "Loaded '{{ p.get('name', part_id) }}'."



  #---------------------------------------------------------------------------
  # Adjust stock
  #---------------------------------------------------------------------------
  asm_adjust_stock:
    alias: "ASM: Adjust Stock"
    mode: single
    sequence:
      - variables:
          part_id: "{{ states('sensor.asm_selected_part') }}"
          delta: "{{ states('input_number.asm_stock_delta') | float(0) }}"
          parts: "{{ state_attr('sensor.asm_data', 'parts') or {} }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ part_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Adjust Stock"
                  message: "Select a part first."
              - stop: "No part"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ delta == 0 }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Adjust Stock"
                  message: "Adjustment is zero."
              - stop: "Zero delta"

      - service: shell_command.asm_adjust_stock
        data:
          part_id: "{{ part_id }}"
          delta: "{{ delta }}"

      - service: input_number.set_value
        target:
          entity_id: input_number.asm_stock_delta
        data:
          value: 0

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Adjust Stock"
          message: >
            {% set p = parts.get(part_id, {}) %}
            {{ p.name | default(part_id) }} adjusted by {{ delta | float | round(1) }}.

  #---------------------------------------------------------------------------
  # Record service event
  #---------------------------------------------------------------------------
  asm_record_service:
    alias: "ASM: Record Service"
    mode: single
    sequence:
      - variables:
          asset_name: "{{ states('input_select.asm_service_asset') }}"
          service_type: "{{ states('input_select.asm_service_type') }}"
          notes: "{{ states('input_text.asm_service_notes') | trim }}"
          hours: "{{ states('input_text.asm_service_hours') | trim }}"
          assets: "{{ state_attr('sensor.asm_data', 'assets') or {} }}"
          parts: "{{ state_attr('sensor.asm_data', 'parts') or {} }}"
          # Find asset ID
          asset_id: >
            {% for aid, a in assets.items() %}
              {% if a.name == asset_name %}
                {{ aid }}
              {% endif %}
            {% endfor %}
          # Build parts consumed array
          parts_json: >
            {% set consumed = [] %}
            {% set p1 = states('input_select.asm_consume_part_1') %}
            {% set q1 = states('input_number.asm_consume_qty_1') | float(0) %}
            {% if p1 != 'None' and q1 > 0 %}
              {% for pid, p in parts.items() if p.name == p1 %}
                {% set consumed = consumed + [{"part_id": pid, "quantity": q1}] %}
              {% endfor %}
            {% endif %}
            {% set p2 = states('input_select.asm_consume_part_2') %}
            {% set q2 = states('input_number.asm_consume_qty_2') | float(0) %}
            {% if p2 != 'None' and q2 > 0 %}
              {% for pid, p in parts.items() if p.name == p2 %}
                {% set consumed = consumed + [{"part_id": pid, "quantity": q2}] %}
              {% endfor %}
            {% endif %}
            {% set p3 = states('input_select.asm_consume_part_3') %}
            {% set q3 = states('input_number.asm_consume_qty_3') | float(0) %}
            {% if p3 != 'None' and q3 > 0 %}
              {% for pid, p in parts.items() if p.name == p3 %}
                {% set consumed = consumed + [{"part_id": pid, "quantity": q3}] %}
              {% endfor %}
            {% endif %}
            {% set p4 = states('input_select.asm_consume_part_4') %}
            {% set q4 = states('input_number.asm_consume_qty_4') | float(0) %}
            {% if p4 != 'None' and q4 > 0 %}
              {% for pid, p in parts.items() if p.name == p4 %}
                {% set consumed = consumed + [{"part_id": pid, "quantity": q4}] %}
              {% endfor %}
            {% endif %}
            {% set p5 = states('input_select.asm_consume_part_5') %}
            {% set q5 = states('input_number.asm_consume_qty_5') | float(0) %}
            {% if p5 != 'None' and q5 > 0 %}
              {% for pid, p in parts.items() if p.name == p5 %}
                {% set consumed = consumed + [{"part_id": pid, "quantity": q5}] %}
              {% endfor %}
            {% endif %}
            {{ consumed | tojson }}

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ asset_name in ['Select Asset', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "ASM Record Service"
                  message: "Select an asset first."
              - stop: "No asset"

      - service: shell_command.asm_record_service
        data:
          asset_id: "{{ asset_id | trim }}"
          service_type: "{{ service_type }}"
          parts: "{{ parts_json }}"
          notes: "{{ notes }}"
          hours: "{{ hours }}"

      - service: script.asm_clear_service_form

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.asm_data

      - service: persistent_notification.create
        data:
          title: "ASM Record Service"
          message: "{{ service_type }} recorded for {{ asset_name }}."

  #---------------------------------------------------------------------------
  # Clear service form
  #---------------------------------------------------------------------------
  asm_clear_service_form:
    alias: "ASM: Clear Service Form"
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.asm_service_asset
        data:
          option: "Select Asset"
      - service: input_text.set_value
        target:
          entity_id:
            - input_text.asm_service_notes
            - input_text.asm_service_hours
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.asm_consume_part_1
            - input_select.asm_consume_part_2
            - input_select.asm_consume_part_3
            - input_select.asm_consume_part_4
            - input_select.asm_consume_part_5
        data:
          option: "None"
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.asm_consume_qty_1
            - input_number.asm_consume_qty_2
            - input_number.asm_consume_qty_3
            - input_number.asm_consume_qty_4
            - input_number.asm_consume_qty_5
        data:
          value: 0
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.asm_show_consume_2
            - input_boolean.asm_show_consume_3
            - input_boolean.asm_show_consume_4
            - input_boolean.asm_show_consume_5
